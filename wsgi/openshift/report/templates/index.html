{% extends "base.html" %}

{% block title %}Report Index{% endblock %}

{% block content %}

<style>
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
.x.axis path {
  display: none;
}
.line {
  fill: none;
  stroke-width: 2px;
}
.overlay {
  fill: none;
  pointer-events: all;
}
.tooltip {
    pointer-events:none; /*let mouse events pass through*/
    opacity:0.7;
    transition: opacity 0.3s;
}
div.tooltip {
    position: absolute;
    text-align:left;
}
.legend {
    font-size: 16px;
    font-weight: bold;
    text-anchor: middle;
}
</style>

<h2>Total start-ups per day</h2>
 <div id="startups-graph"></div>

<h2>Available Reports:</h2>
<ul>
    <li><a href="{% url "host" %}">hosts</a></li>
    <li><a href="{% url "user" %}">users</a></li>
</ul>
{% endblock %}

{% block post_main_script %}
{% load staticfiles %}
<script charset="utf-8" src="{% static "report/js/vendor/d3-3.5.3.min-js" %}"></script>

<script type='text/javascript'>
var div_width = parseInt(d3.select("#startups-graph").style("width"))
var margin = {top: 30, right: 20, bottom: 70, left: 60},
    width = div_width - 100 - margin.left - margin.right,
    height = (div_width * 4 / 7) - margin.top - margin.bottom;

var parseDate=d3.time.format("%Y-%m-%d").parse;

var x = d3.time.scale()
          .range([0, width]);

var y = d3.scale.linear()
          .range([height, 0]);

var xAxis = d3.svg.axis()
              .scale(x)
              .orient("bottom");

var yAxis = d3.svg.axis()
              .scale(y)
              .orient("left");

var line = d3.svg.line()
    .interpolate("basis")
    .x(function(d) { return x(d.date); })
    .y(function(d) { return y(d.count); });

var color = d3.scale.category10();

var startpoint = new Date();
startpoint.setDate(startpoint.getDate() - 14);
startpoint = (startpoint.getFullYear()) + '-'
           + (startpoint.getMonth() + 1) + '-'
           + (startpoint.getDate());

var endpoint = '/api/by/start/?datemin='+startpoint;
window.console.log(endpoint);


$(document).ready(function() {
  $.getJSON(endpoint, function(data) {
    // window.console.log(data);
    data.forEach(function(d) {
      d.date = parseDate(d.date);
    });

    color.domain(d3.keys(data[0]).filter(function(key) { return key !== "date"; }));
    var systems = color.domain().map(function(name) {
      return {
        name: name,
        values: data.map(function(d) {
          return {date: d.date, count: +d[name]};
        })
      };
    });

    var svg = d3.select("#startups-graph").append("svg:svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("svg:g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    x.domain(d3.extent(data, function(d) { return d.date; }));
    svg.append("g")
       .attr("class", "x axis")
       .attr("transform", "translate(0," + height + ")")
       .call(xAxis);
    y.domain([
      d3.min(systems, function(c) { return d3.min(c.values, function(v) { return v.count; }); }),
      d3.max(systems, function(c) { return d3.max(c.values, function(v) { return v.count; }); })
    ]);
    svg.append("g")
       .attr("class", "y axis")
       .call(yAxis)
       .append("text")
       .attr("transform", "rotate(-90)")
       .attr("y", 6)
       .attr("dy", ".71em")
       .style("text-anchor", "end");

    var system = svg.selectAll('.system')
                    .data(systems)
                    .enter().append('g')
                    .attr('class','system');

    legendSpace = width/systems.length; // spacing for legend

    // Loop through each symbol / key
    systems.forEach(function(d,i) {

        svg.append("path")
            .attr("class", "line")
            .style("stroke", function() { // Add the colours dynamically
                return d.color = color(d.name); })
            .attr("id", 'tag'+d.name.replace(/\s+/g, '')) // assign ID
            .attr("d", line(d.values));

        // Add the Legend
        svg.append("text")
            .attr("x", (legendSpace/2)+i*legendSpace) // spacing
            .attr("y", height + (margin.bottom/2)+ 5)
            .attr("class", "legend")    // style the legend
            .style("fill", function() { // dynamic colours
                return d.color = color(d.name); })
            .on("click", function(){
                // Determine if current line is visible 
                var active   = d.active ? false : true,
                newOpacity = active ? 0 : 1;
                // Hide or show the elements based on the ID
                d3.select("#tag"+d.name.replace(/\s+/g, ''))
                    .transition().duration(100)
                    .style("opacity", newOpacity);
                // Update whether or not the elements are active
                d.active = active;
                })
            .text(d.name); 

    });
  });
});
</script>
{% endblock %}
